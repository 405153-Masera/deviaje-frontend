<div class="container my-4">

    <!-- Loading -->
    <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3">Cargando detalles de la reserva...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error && !loading" class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ error }}
        <button class="btn btn-primary mt-3" (click)="goBack()">
            Volver a mis reservas
        </button>
    </div>

    <!-- Contenido principal -->
    <div *ngIf="!loading && !error && bookingDetails">

        <!-- Header con acciones -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <h2 class="mb-1">Detalle de Reserva</h2>
                        <p class="text-muted mb-0">{{ bookingDetails.bookingReference }}</p>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-secondary" (click)="goBack()">
                            <i class="bi bi-arrow-left me-1"></i> Volver
                        </button>
                        <button class="btn btn-success" (click)="downloadVoucher()">
                            <i class="bi bi-download me-1"></i> Descargar Voucher
                        </button>
                        <button class="btn btn-primary" (click)="resendVoucher()">
                            <i class="bi bi-envelope me-1"></i> Enviar por Email
                        </button>
                        <button class="btn btn-danger" (click)="cancelBooking()">
                            <i class="bi bi-x-circle me-1"></i> Cancelar Reserva
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información general -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>
                            Información General
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">

                            <div class="col-md-3">
                                <small class="text-muted d-block">Tipo de Reserva</small>
                                <span class="badge bg-secondary-subtle text-dark border fs-6">
                                    {{ getBookingTypeName(bookingDetails.type) }}
                                </span>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Estado</small>
                                <span class="badge fs-6" [ngClass]="getStatusBadgeClass(bookingDetails.status)">
                                    {{ getBookingStatusName(bookingDetails.status) }}
                                </span>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Fecha de Reserva</small>
                                <strong>{{ formatDate(bookingDetails.createdDatetime) }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Monto Total</small>
                                <strong class="text-success fs-5">
                                    {{ formatCurrency(bookingDetails.totalAmount, bookingDetails.currency) }}
                                </strong>
                            </div>

                            <div class="col-md-4">
                                <small class="text-muted d-block">Titular</small>
                                <strong>{{ bookingDetails.holderName }}</strong>
                            </div>

                            <div class="col-md-4">
                                <small class="text-muted d-block">Email</small>
                                <strong>{{ bookingDetails.email }}</strong>
                            </div>

                            <div class="col-md-4">
                                <small class="text-muted d-block">Teléfono</small>
                                <strong>{{ bookingDetails.countryCallingCode }} {{ bookingDetails.phone }}</strong>
                            </div>

                        </div>

                        <!-- Desglose de precios -->
                        <hr class="my-3">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <small class="text-muted d-block">Subtotal</small>
                                <strong>{{ formatCurrency(bookingDetails.totalAmount - bookingDetails.taxes,
                                    bookingDetails.currency) }}</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">Impuestos</small>
                                <strong>{{ formatCurrency(bookingDetails.taxes, bookingDetails.currency) }}</strong>
                            </div>
                            <div class="col-md-3" *ngIf="bookingDetails.discount > 0">
                                <small class="text-muted d-block">Descuento</small>
                                <strong class="text-danger">-{{ formatCurrency(bookingDetails.discount,
                                    bookingDetails.currency) }}</strong>
                            </div>
                            <div class="col-md-3" *ngIf="bookingDetails.commission > 0">
                                <small class="text-muted d-block">Comisión</small>
                                <strong>{{ formatCurrency(bookingDetails.commission, bookingDetails.currency)
                                    }}</strong>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Detalles de VUELO -->
        <div class="row mb-4" *ngIf="bookingDetails.flightDetails">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-airplane me-2"></i>
                            Detalles del Vuelo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">

                            <div class="col-md-3">
                                <small class="text-muted d-block">Origen</small>
                                <strong class="fs-5">{{ bookingDetails.flightDetails.origin }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Destino</small>
                                <strong class="fs-5">{{ bookingDetails.flightDetails.destination }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Aerolínea</small>
                                <strong>{{ bookingDetails.flightDetails.carrier }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Código de Reserva Externa</small>
                                <strong>{{ bookingDetails.flightDetails.externalId }}</strong>
                            </div>

                            <div class="col-md-4">
                                <small class="text-muted d-block">Salida</small>
                                <strong>{{ formatSimpleDate(bookingDetails.flightDetails.departureDate) }}</strong>
                            </div>

                            <div class="col-md-4">
                                <small class="text-muted d-block">Llegada</small>
                                <strong>{{ formatSimpleDate(bookingDetails.flightDetails.arrivalDate) }}</strong>
                            </div>

                            <div class="col-md-4">
                                <small class="text-muted d-block">Duración</small>
                                <strong>{{ getFlightDuration(bookingDetails.flightDetails.departureDate,
                                    bookingDetails.flightDetails.arrivalDate) }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Adultos</small>
                                <strong>{{ bookingDetails.flightDetails.adults }}</strong>
                            </div>

                            <div class="col-md-3" *ngIf="bookingDetails.flightDetails.children > 0">
                                <small class="text-muted d-block">Niños</small>
                                <strong>{{ bookingDetails.flightDetails.children }}</strong>
                            </div>

                            <div class="col-md-3" *ngIf="bookingDetails.flightDetails.infants > 0">
                                <small class="text-muted d-block">Infantes</small>
                                <strong>{{ bookingDetails.flightDetails.infants }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Total Pasajeros</small>
                                <strong>{{ getTotalPassengers() }}</strong>
                            </div>

                        </div>

                        <!-- Itinerario JSON (si existe) -->
                        <div *ngIf="bookingDetails.flightDetails.itinerariesJson" class="mt-3">
                            <hr>
                            <h6 class="text-muted">Itinerario Completo</h6>
                            <div class="alert alert-info">
                                <small>
                                    <pre>{{ bookingDetails.flightDetails.itinerariesJson | json }}</pre>
                                </small>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Detalles de HOTEL -->
        <div class="row mb-4" *ngIf="bookingDetails.hotelDetails">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-building me-2"></i>
                            Detalles del Hotel
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">

                            <div class="col-md-6">
                                <small class="text-muted d-block">Hotel</small>
                                <strong class="fs-5">{{ bookingDetails.hotelDetails.hotelName }}</strong>
                            </div>

                            <div class="col-md-6">
                                <small class="text-muted d-block">Ubicación</small>
                                <strong>{{ bookingDetails.hotelDetails.destinationName }}, {{
                                    bookingDetails.hotelDetails.countryName }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Código de Reserva Externa</small>
                                <strong>{{ bookingDetails.hotelDetails.externalId }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Check-in</small>
                                <strong>{{ formatSimpleDate(bookingDetails.hotelDetails.checkInDate) }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Check-out</small>
                                <strong>{{ formatSimpleDate(bookingDetails.hotelDetails.checkOutDate) }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Noches</small>
                                <strong>{{ bookingDetails.hotelDetails.numberOfNights }}</strong>
                            </div>

                            <div class="col-md-6">
                                <small class="text-muted d-block">Tipo de Habitación</small>
                                <strong>{{ bookingDetails.hotelDetails.roomName }}</strong>
                            </div>

                            <div class="col-md-6">
                                <small class="text-muted d-block">Régimen de Comidas</small>
                                <strong>{{ bookingDetails.hotelDetails.boardName }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Habitaciones</small>
                                <strong>{{ bookingDetails.hotelDetails.numberOfRooms }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Adultos</small>
                                <strong>{{ bookingDetails.hotelDetails.adults }}</strong>
                            </div>

                            <div class="col-md-3" *ngIf="bookingDetails.hotelDetails.children > 0">
                                <small class="text-muted d-block">Niños</small>
                                <strong>{{ bookingDetails.hotelDetails.children }}</strong>
                            </div>

                            <div class="col-md-3">
                                <small class="text-muted d-block">Total Huéspedes</small>
                                <strong>{{ getTotalGuests() }}</strong>
                            </div>

                        </div>

                        <!-- Detalles adicionales del hotel (JSON) -->
                        <div *ngIf="bookingDetails.hotelDetails.hotelBookingJson" class="mt-3">
                            <hr>
                            <h6 class="text-muted">Información Adicional</h6>

                            <!-- Si hay rateComment, mostrarlo destacado -->
                            <div *ngIf="bookingDetails.hotelDetails.hotelBookingJson.rateComment"
                                class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Importante:</strong> {{ bookingDetails.hotelDetails.hotelBookingJson.rateComment
                                }}
                            </div>

                            <!-- Mostrar todo el JSON -->
                            <div class="alert alert-info">
                                <small>
                                    <pre>{{ bookingDetails.hotelDetails.hotelBookingJson | json }}</pre>
                                </small>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de Pagos -->
        <div class="row mb-4" *ngIf="bookingDetails.payments && bookingDetails.payments.length > 0">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-credit-card me-2"></i>
                            Historial de Pagos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Tipo</th>
                                        <th>Método</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                        <th>ID Externa</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let payment of bookingDetails.payments">
                                        <td>{{ payment.id }}</td>
                                        <td>{{ payment.paymentType }}</td>
                                        <td>{{ getPaymentMethodName(payment.paymentMethod) }}</td>
                                        <td class="fw-semibold">{{ formatCurrency(payment.amount, payment.currency) }}
                                        </td>
                                        <td>
                                            <span class="badge" [ngClass]="getPaymentStatusClass(payment.status)">
                                                {{ getPaymentStatusName(payment.status) }}
                                            </span>
                                        </td>
                                        <td>{{ payment.externalId }}</td>
                                        <td>{{ formatDate(payment.createdDatetime) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>