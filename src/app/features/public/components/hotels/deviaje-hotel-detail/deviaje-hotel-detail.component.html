<div class="hotel-detail-container">
    <div class="container py-4">
      <!-- Botón para volver a resultados (solo si no es modo paquete) -->
      @if (!inPackageMode) {
        <div class="back-button mb-4">
          <button class="btn btn-outline" (click)="router.navigate(['/home/hotels/results'])">
            <i class="bi bi-arrow-left me-2"></i> Volver a resultados
          </button>
        </div>
      }
  
      <!-- Estado de carga -->
      @if (isLoading) {
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Cargando información del hotel...</p>
        </div>
      }
  
      <!-- Mensaje de error -->
      @if (hasError || errorMessage) {
        <div class="alert alert-danger" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          {{ errorMessage || 'Error al cargar los detalles del hotel. Por favor, intenta de nuevo.' }}
          @if (hasError) {
            <button class="btn btn-sm btn-outline-danger ms-2" (click)="loadHotelDetails()">
              Intentar de nuevo
            </button>
          }
        </div>
      }
  
      <!-- Detalle del hotel -->
      @if (!isLoading && !hasError && hotel) {
        <div class="row">
          <!-- Información principal del hotel -->
          <div class="col-12">
            <div class="hotel-header card">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start flex-wrap">
                  <div>
                    <h1 class="hotel-title">{{ hotel.name }}</h1>
                    <div class="hotel-stars mb-2">
                      @for (i of [1, 2, 3, 4, 5]; track i) {
                        <i class="bi bi-star-fill" [class.text-warning]="i <= getCategoryStars(hotel.categoryCode || '')"></i>
                      }
                    </div>
                    <p class="hotel-location">
                      <i class="bi bi-geo-alt-fill me-1"></i> {{ hotel.destinationCode }}
                    </p>
                  </div>
                  <div class="hotel-price text-end">
                    <div class="price-from">Total estimado</div>
                    <div class="price-amount">{{ formatPrice(getTotalPrice(), searchParams?.currency) }}</div>
                    <div class="price-night">{{ getNightsCount() }} noche{{ getNightsCount() > 1 ? 's' : '' }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
  
          <!-- Galería de imágenes (solo si no es modo paquete) -->
          @if (!inPackageMode) {
            <div class="col-md-8 mt-4">
              <div class="hotel-gallery card">
                <div class="card-body p-0">
                  <div class="main-image position-relative">
                    <img [src]="getHotelMainImage()" alt="{{ hotel.name }}" class="img-fluid">
                    <div class="gallery-controls">
                      <button class="gallery-control prev" (click)="prevImage()">
                        <i class="bi bi-chevron-left"></i>
                      </button>
                      <button class="gallery-control next" (click)="nextImage()">
                        <i class="bi bi-chevron-right"></i>
                      </button>
                    </div>
                  </div>
                  <div class="thumbnails d-flex mt-2">
                    @for (image of getThumbnailImages(); track $index) {
                      <div class="thumbnail" 
                           [class.active]="currentImageIndex === $index"
                           (click)="selectImage($index)">
                        <img [src]="image.path" alt="Thumbnail" class="img-fluid">
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          }
  
          <!-- Información del hotel y detalles (solo si no es modo paquete) -->
          @if (!inPackageMode) {
            <div class="col-md-4 mt-4">
              <div class="hotel-info card mb-4">
                <div class="card-header">
                  <h4 class="mb-0">Información del hotel</h4>
                </div>
                <div class="card-body">
                  @if (hotelDetails) {
                    <div class="hotel-description mb-3">
                      <p>{{ hotelDetails.description }}</p>
                    </div>
                    
                    <h5 class="mt-4 mb-3">Ubicación</h5>
                    <p class="address">
                      <i class="bi bi-geo-alt me-2"></i>
                      {{ hotelDetails.address }}
                    </p>
                    <p class="city">
                      <i class="bi bi-building me-2"></i>
                      {{ hotelDetails.city }}, {{ hotelDetails.country?.name }}
                    </p>
                  }
                </div>
              </div>
            </div>
          }
  
          <!-- Tabla de selección de habitaciones -->
          <div class="col-12 mt-4">
            <div class="card">
              <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                  <i class="bi bi-house-door me-2"></i>
                  Selecciona las opciones para tus habitaciones
                </h4>
              </div>
              <div class="card-body p-0">
                @if (roomSelections.length > 0) {
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th scope="col" class="ps-4">Habitación</th>
                          <th scope="col">Opción seleccionada</th>
                          <th scope="col">Política de cancelación</th>
                          <th scope="col" class="text-end pe-4">Precio</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (roomSelection of roomSelections; track roomSelection.roomIndex) {
                          <tr>
                            <!-- Columna 1: Información de la habitación y selector -->
                            <td class="ps-4">
                              <div class="room-info">
                                <h6 class="mb-1">Habitación {{ roomSelection.roomIndex + 1 }}</h6>
                                <small class="text-muted">{{ getRoomDescription(roomSelection) }}</small>
                                
                                <div class="mt-2">
                                  @if (roomSelection.availableRates.length > 0) {
                                    <select 
                                      class="form-select form-select-sm"
                                      [value]="roomSelection.selectedRate?.rateKey || ''"
                                      (change)="onRateSelectionChange(roomSelection.roomIndex, $event)"
                                      [disabled]="roomSelection.isValidating">
                                      <option value="">Selecciona una opción</option>
                                      @for (rate of roomSelection.availableRates; track rate.rateKey) {
                                        <option [value]="rate.rateKey">
                                          {{ rate.boardName || 'Solo habitación' }}
                                          @if (getRateOffers(rate).length > 0) {
                                            - {{ getRateOffers(rate)[0].name }}
                                          }
                                        </option>
                                      }
                                    </select>
                                    
                                    @if (roomSelection.isValidating) {
                                      <div class="mt-1">
                                        <small class="text-info">
                                          <i class="bi bi-clock-history me-1"></i>
                                          Validando disponibilidad...
                                        </small>
                                      </div>
                                    }
                                  } @else {
                                    <div class="alert alert-warning mb-0 py-2">
                                      <small>No hay opciones disponibles para esta configuración</small>
                                    </div>
                                  }
                                </div>
                              </div>
                            </td>
                            
                            <!-- Columna 2: Detalles de la opción seleccionada -->
                            <td>
                              @if (roomSelection.selectedRate) {
                                <div class="rate-details">
                                  <div class="fw-semibold">{{ roomSelection.selectedRate.boardName || 'Solo habitación' }}</div>
                                  
                                  @if (getRateOffers(roomSelection.selectedRate).length > 0) {
                                    <div class="text-success mt-1">
                                      <small>
                                        <i class="bi bi-tag me-1"></i>
                                        {{ getRateOffers(roomSelection.selectedRate)[0].name }}
                                        ({{ formatPrice(getRateOffers(roomSelection.selectedRate)[0].amount, searchParams?.currency) }})
                                      </small>
                                    </div>
                                  }
                                  
                                  <div class="mt-1">
                                    <small class="text-muted">
                                      {{ getRateAdults(roomSelection.selectedRate) }} adulto{{ getRateAdults(roomSelection.selectedRate) > 1 ? 's' : '' }}
                                      @if (getRateChildren(roomSelection.selectedRate) > 0) {
                                        , {{ getRateChildren(roomSelection.selectedRate) }} niño{{ getRateChildren(roomSelection.selectedRate) > 1 ? 's' : '' }}
                                      }
                                    </small>
                                  </div>
                                  
                                  @if (getRateClass(roomSelection.selectedRate)) {
                                    <div class="mt-1">
                                      <span class="badge bg-secondary">{{ getRateClass(roomSelection.selectedRate) }}</span>
                                    </div>
                                  }
                                </div>
                              } @else {
                                <span class="text-muted">
                                  <i>Selecciona una opción</i>
                                </span>
                              }
                            </td>
                            
                            <!-- Columna 3: Política de cancelación -->
                            <td>
                              @if (roomSelection.selectedRate?.cancellationPolicies) {
                                <div class="cancellation-policy">
                                  <small>{{ formatCancellationPolicy(roomSelection.selectedRate?.cancellationPolicies) }}</small>
                                </div>
                              } @else if (roomSelection.selectedRate) {
                                <small class="text-muted">No especificada</small>
                              } @else {
                                <span class="text-muted">-</span>
                              }
                            </td>
                            
                            <!-- Columna 4: Precio -->
                            <td class="text-end pe-4">
                              @if (roomSelection.selectedRate) {
                                <div class="price-info">
                                  <div class="fw-bold text-primary">
                                    {{ formatPrice(getRateNet(roomSelection.selectedRate), searchParams?.currency) }}
                                  </div>
                                  <small class="text-muted">
                                    {{ formatPrice(getRateNet(roomSelection.selectedRate) / getNightsCount(), searchParams?.currency) }} / noche
                                  </small>
                                </div>
                              } @else {
                                <span class="text-muted">-</span>
                              }
                            </td>
                          </tr>
                        }
                      </tbody>
                      <tfoot class="table-light">
                        <tr>
                          <td colspan="3" class="ps-4 fw-semibold">Total de la reserva</td>
                          <td class="text-end pe-4">
                            <div class="fw-bold h5 text-primary mb-0">
                              {{ formatPrice(getTotalPrice(), searchParams?.currency) }}
                            </div>
                            <small class="text-muted">{{ getNightsCount() }} noche{{ getNightsCount() > 1 ? 's' : '' }}</small>
                          </td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                } @else {
                  <div class="text-center py-4">
                    <p class="mb-0">No se pudieron cargar las opciones de habitaciones.</p>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
  
        <!-- Botón de reserva -->
        @if (!inPackageMode) {
          <div class="row mt-4">
            <div class="col-12">
              <div class="card">
                <div class="card-body d-flex justify-content-between align-items-center">
                  <div>
                    <h5 class="mb-1">¿Listo para reservar?</h5>
                    <small class="text-muted">
                      @if (!canProceedToBooking()) {
                        Selecciona una opción para todas las habitaciones
                      } @else {
                        Todas las habitaciones configuradas correctamente
                      }
                    </small>
                  </div>
                  <button 
                    class="btn btn-primary btn-lg"
                    [disabled]="!canProceedToBooking()"
                    (click)="bookHotel()">
                    <i class="bi bi-credit-card me-2"></i>
                    Continuar con la reserva
                  </button>
                </div>
              </div>
            </div>
          </div>
        }
      }
    </div>
  </div>